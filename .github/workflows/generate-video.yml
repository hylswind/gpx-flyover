name: Generate Video

on:
  workflow_dispatch:
    inputs:
      gpx_url:
        description: "GPX file URL — supports Google Drive share links or any direct download URL"
        required: true
        type: string
      duration:
        description: "Video duration (seconds)"
        required: false
        type: choice
        default: "30"
        options:
          - "10"
          - "30"
          - "60"
          - "120"
          - "180"
      quality:
        description: "Video quality"
        required: false
        type: choice
        default: "fast"
        options:
          - fast
          - medium
          - high
      format:
        description: "Output format"
        required: false
        type: choice
        default: "youtube"
        options:
          - youtube
          - instagram
          - tiktok
          - square
      tile_zoom:
        description: "Map tile zoom level (higher = sharper, slower)"
        required: false
        type: choice
        default: "16"
        options:
          - "14"
          - "15"
          - "16"
          - "17"

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3

      - uses: pyvista/setup-headless-display-action@v3

      - name: Install gpx-flyover
        run: pip install .

      - name: Cache tiles and elevation data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/gpx-flyover
            ~/.cache/srtm
          key: gpx-flyover-cache-${{ inputs.tile_zoom }}
          restore-keys: |
            gpx-flyover-cache-

      - name: Download GPX file
        env:
          GPX_URL: ${{ inputs.gpx_url }}
        run: |
          if [[ "$GPX_URL" != https://* ]]; then
            echo "::error::Only HTTPS URLs are allowed" && exit 1
          fi

          # Convert Google Drive share links to direct download URLs
          if [[ "$GPX_URL" =~ drive\.google\.com/file/d/([a-zA-Z0-9_-]+) ]]; then
            FILE_ID="${BASH_REMATCH[1]}"
            GPX_URL="https://drive.google.com/uc?export=download&id=${FILE_ID}"
            echo "Converted Google Drive share link (file ID: ${FILE_ID})"
          fi

          echo "Downloading from: $GPX_URL"
          curl -fL --proto '=https' --max-filesize 52428800 -o input.gpx "$GPX_URL"

      - name: Validate GPX file
        run: |
          echo "File size: $(wc -c < input.gpx) bytes"
          head_bytes=$(head -c 500 input.gpx)

          if echo "$head_bytes" | grep -qi '<!DOCTYPE html\|<html'; then
            echo "::error::Downloaded file is an HTML page, not a GPX file."
            echo ""
            echo "The URL points to a web page, not a direct file download."
            echo ""
            echo "How to fix:"
            echo "  1. Export the GPX file from your app (Strava, Komoot, Garmin, etc.)"
            echo "  2. Upload the .gpx file to Google Drive"
            echo "  3. Right-click → Share → set to 'Anyone with the link'"
            echo "  4. Copy the share link and paste it here"
            exit 1
          fi

          if ! echo "$head_bytes" | grep -q '<?xml\|<gpx'; then
            echo "::error::Downloaded file does not appear to be a GPX file."
            echo ""
            echo "First 200 bytes:"
            head -c 200 input.gpx
            exit 1
          fi

          echo "GPX file validated OK"

      - name: Generate video
        env:
          QUALITY: ${{ inputs.quality }}
          FORMAT: ${{ inputs.format }}
          DURATION: ${{ inputs.duration }}
          TILE_ZOOM: ${{ inputs.tile_zoom }}
        run: |
          gpx-flyover input.gpx output.mp4 \
            --quality "$QUALITY" \
            --format "$FORMAT" \
            --duration "$DURATION" \
            --tile-zoom "$TILE_ZOOM"

      - name: Upload video
        uses: actions/upload-artifact@v4
        with:
          name: gpx-flyover-output
          path: output.mp4
          retention-days: 1
